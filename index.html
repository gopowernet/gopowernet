<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>PowerNet AI Assistant</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script type="importmap">
{
  "imports": {
    "react": "https://esm.sh/react@18.3.1",
    "react-dom/client": "https://esm.sh/react-dom@18.3.1/client",
    "@google/genai": "https://esm.sh/@google/genai@0.14.0"
  }
}
</script>
    <style>
      @keyframes fade-in-up {
        0% {
          opacity: 0;
          transform: translateY(10px);
        }
        100% {
          opacity: 1;
          transform: translateY(0);
        }
      }
      .animate-fade-in-up {
        animation: fade-in-up 0.3s ease-out forwards;
      }
       @keyframes fade-in {
        0% { opacity: 0; }
        100% { opacity: 1; }
      }
      .animate-fade-in {
        animation: fade-in 0.2s ease-out forwards;
      }
      @keyframes bounce {
        0%, 100% {
            transform: translateY(-25%);
            animation-timing-function: cubic-bezier(0.8, 0, 1, 1);
        }
        50% {
            transform: translateY(0);
            animation-timing-function: cubic-bezier(0, 0, 0.2, 1);
        }
      }
      .animate-bounce {
          animation: bounce 1s infinite;
      }
    </style>
</head>
<body>
    <div id="root"></div>
    <script type="module">
import React, { useState, useCallback, useRef, useEffect } from 'react';
import ReactDOM from 'react-dom/client';
import { GoogleGenAI } from '@google/genai';

// --- START OF ICONS ---
const UserIcon = (props) => React.createElement('svg', { ...props, xmlns: "http://www.w3.org/2000/svg", viewBox: "0 0 24 24", fill: "currentColor" },
    React.createElement('path', { d: "M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z" })
);

const BotIcon = (props) => React.createElement('svg', { ...props, xmlns: "http://www.w3.org/2000/svg", viewBox: "0 0 24 24", fill: "currentColor" },
    React.createElement('path', { d: "M19 8h-1V4h-2v4h-4V4H9v4H8c-1.1 0-2 .9-2 2v10c0 1.1.9 2 2 2h11c1.1 0 2-.9 2-2V10c0-1.1-.9-2-2-2zm-6 10c-.55 0-1-.45-1-1s.45-1 1-1 1 .45 1 1-.45 1-1 1zm4 0c-.55 0-1-.45-1-1s.45-1 1-1 1 .45 1 1-.45 1-1 1zm-8 0c-.55 0-1-.45-1-1s.45-1 1-1 1 .45 1 1-.45 1-1 1zM17 9H8V7h9v2z" })
);

const SendIcon = (props) => React.createElement('svg', { ...props, xmlns: "http://www.w3.org/2000/svg", viewBox: "0 0 24 24", fill: "currentColor" },
    React.createElement('path', { d: "M2.01 21L23 12 2.01 3 2 10l15 2-15 2z" })
);

const PowerNetIcon = (props) => React.createElement('svg', { ...props, xmlns: "http://www.w3.org/2000/svg", viewBox: "0 0 24 24", fill: "currentColor" },
    React.createElement('path', { d: "M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-2 15h-2V7h4c2.76 0 5 2.24 5 5s-2.24 5-5 5h-2v-2zm0-6h2c1.66 0 3-1.34 3-3s-1.34-3-3-3h-2v6z" })
);

const CloseIcon = (props) => React.createElement('svg', { ...props, xmlns: "http://www.w3.org/2000/svg", viewBox: "0 0 24 24", fill: "currentColor" },
    React.createElement('path', { d: "M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z" })
);

const SettingsIcon = (props) => React.createElement('svg', { ...props, xmlns: "http://www.w3.org/2000/svg", viewBox: "0 0 24 24", fill: "currentColor" },
    React.createElement('path', { d: "M19.43 12.98c.04-.32.07-.64.07-.98s-.03-.66-.07-.98l2.11-1.65c.19-.15.24-.42.12-.64l-2-3.46c-.12-.22-.39-.3-.61-.22l-2.49 1c-.52-.4-1.08-.73-1.69-.98l-.38-2.65C14.46 2.18 14.25 2 14 2h-4c-.25 0-.46.18-.49.42l-.38 2.65c-.61.25-1.17.59-1.69.98l-2.49-1c-.23-.09-.49 0-.61.22l-2 3.46c-.13.22-.07.49.12.64l2.11 1.65c-.04.32-.07.65-.07.98s.03.66.07.98l-2.11 1.65c-.19.15-.24.42-.12.64l2 3.46c.12.22.39.3.61.22l2.49-1c.52.4 1.08.73 1.69.98l.38 2.65c.03.24.24.42.49.42h4c.25 0 .46-.18.49-.42l.38-2.65c.61-.25 1.17-.59 1.69.98l2.49 1c.23.09.49 0 .61.22l2-3.46c.12-.22.07-.49-.12-.64l-2.11-1.65zM12 15.5c-1.93 0-3.5-1.57-3.5-3.5s1.57-3.5 3.5-3.5 3.5 1.57 3.5 3.5-1.57 3.5-3.5 3.5z" })
);
// --- END OF ICONS ---


// --- START OF ADMIN PANEL COMPONENT ---
const AdminPanel = ({ files, onAddFile, onRemoveFile, onClose }) => {
    const fileInputRef = useRef(null);

    const handleFileChange = (e) => {
        if (e.target.files && e.target.files[0]) {
            onAddFile(e.target.files[0]);
            e.target.value = '';
        }
    };

    const handleAddClick = () => {
        fileInputRef.current?.click();
    };

    return React.createElement('div', {
            className: "fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 animate-fade-in",
            onClick: onClose,
            'aria-modal': "true",
            role: "dialog"
        },
        React.createElement('div', {
                className: "bg-white rounded-2xl shadow-2xl w-full max-w-lg m-4 flex flex-col max-h-[80vh]",
                onClick: e => e.stopPropagation()
            },
            React.createElement('header', { className: "flex items-center justify-between p-4 border-b border-slate-200" },
                React.createElement('h2', { className: "text-lg font-bold text-slate-800" }, "지식 베이스 관리"),
                React.createElement('button', { onClick: onClose, className: "p-2 rounded-full text-slate-500 hover:bg-slate-200", 'aria-label': "Close panel" },
                    React.createElement(CloseIcon, { className: "w-5 h-5" })
                )
            ),
            React.createElement('main', { className: "flex-1 p-6 overflow-y-auto" },
                React.createElement('p', { className: "text-sm text-slate-600 mb-4" }, "여기에 문서를 업로드하면 AI가 답변의 근거로 사용합니다. 현재는 브라우저에만 임시 저장되며, 페이지를 새로고침하면 사라집니다."),
                React.createElement('div', { className: "space-y-3" },
                    files.length === 0 ?
                    React.createElement('p', { className: "text-center text-slate-500 py-4" }, "업로드된 문서가 없습니다.") :
                    files.map(file => React.createElement('div', { key: file.name, className: "flex items-center justify-between p-3 bg-slate-50 rounded-lg border border-slate-200" },
                        React.createElement('span', { className: "truncate text-sm text-slate-800 flex-1 mr-2" }, file.name),
                        React.createElement('button', {
                                type: "button",
                                onClick: () => onRemoveFile(file.name),
                                className: "flex-shrink-0 text-slate-500 hover:text-red-600 transition-colors",
                                'aria-label': `Remove ${file.name}`
                            },
                            React.createElement(CloseIcon, { className: "w-4 h-4" })
                        )
                    ))
                )
            ),
            React.createElement('footer', { className: "p-4 border-t border-slate-200" },
                React.createElement('input', { type: "file", ref: fileInputRef, onChange: handleFileChange, className: "hidden" }),
                React.createElement('button', {
                        onClick: handleAddClick,
                        className: "w-full bg-blue-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-blue-700 transition-colors duration-200 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500"
                    },
                    "문서 추가"
                )
            )
        )
    );
};
// --- END OF ADMIN PANEL COMPONENT ---


// --- START OF CHAT MESSAGE COMPONENT ---
const TypingIndicator = () => React.createElement('div', { className: "flex items-center space-x-1" },
    React.createElement('span', { className: "w-2 h-2 bg-slate-500 rounded-full animate-bounce", style: { animationDelay: '0s' } }),
    React.createElement('span', { className: "w-2 h-2 bg-slate-500 rounded-full animate-bounce", style: { animationDelay: '0.1s' } }),
    React.createElement('span', { className: "w-2 h-2 bg-slate-500 rounded-full animate-bounce", style: { animationDelay: '0.2s' } })
);

const ChatMessage = ({ message, isLastMessage }) => {
    const { sender, text } = message;
    const isUser = sender === 'user';

    return React.createElement('div', { className: `flex items-start space-x-4 ${isUser ? 'justify-end' : ''}` },
        !isUser && React.createElement('div', { className: "flex-shrink-0 w-8 h-8 rounded-full bg-slate-200 flex items-center justify-center" },
            React.createElement(BotIcon, { className: "w-5 h-5 text-slate-500" })
        ),
        React.createElement('div', {
                className: `px-4 py-3 rounded-xl max-w-lg animate-fade-in-up ${isUser ? 'bg-blue-600 text-white rounded-br-none' : 'bg-slate-200 text-slate-900 rounded-bl-none'}`
            },
            (text === '' && isLastMessage) ? React.createElement(TypingIndicator, null) : React.createElement('p', { className: "whitespace-pre-wrap" }, text)
        ),
        isUser && React.createElement('div', { className: "flex-shrink-0 w-8 h-8 rounded-full bg-slate-300 flex items-center justify-center" },
            React.createElement(UserIcon, { className: "w-5 h-5 text-slate-600" })
        )
    );
};
// --- END OF CHAT MESSAGE COMPONENT ---


// --- START OF CHAT INPUT COMPONENT ---
const ChatInput = ({ onSend, isLoading }) => {
    const [text, setText] = useState('');
    const textareaRef = useRef(null);

    useEffect(() => {
        if (textareaRef.current) {
            textareaRef.current.style.height = 'auto';
            textareaRef.current.style.height = `${textareaRef.current.scrollHeight}px`;
        }
    }, [text]);

    const handleSubmit = (e) => {
        e?.preventDefault();
        if (text.trim()) {
            onSend(text);
            setText('');
        }
    };

    const handleKeyDown = (e) => {
        if (e.key === 'Enter' && !e.shiftKey) {
            e.preventDefault();
            handleSubmit();
        }
    };

    return React.createElement('form', { onSubmit: handleSubmit, className: "flex items-end space-x-3" },
        React.createElement('textarea', {
            ref: textareaRef,
            value: text,
            onChange: (e) => setText(e.target.value),
            onKeyDown: handleKeyDown,
            placeholder: "메시지를 입력하세요...",
            disabled: isLoading,
            rows: 1,
            className: "flex-1 w-full p-3 bg-slate-100 rounded-xl resize-none focus:outline-none focus:ring-2 focus:ring-blue-500 disabled:opacity-50 transition-shadow duration-200",
            style: { maxHeight: '120px' }
        }),
        React.createElement('button', {
                type: "submit",
                disabled: isLoading || !text.trim(),
                className: "flex-shrink-0 w-12 h-12 bg-blue-600 text-white rounded-full flex items-center justify-center transition-colors duration-200 hover:bg-blue-700 disabled:bg-slate-300 disabled:cursor-not-allowed focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500",
                'aria-label': "Send message"
            },
            React.createElement(SendIcon, { className: "w-6 h-6" })
        )
    );
};
// --- END OF CHAT INPUT COMPONENT ---


// --- START OF APP COMPONENT ---
const fileToGenerativePart = (file) => {
    return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onload = () => {
            const base64Data = reader.result;
            const data = base64Data.split(',')[1];
            resolve({
                inlineData: {
                    data,
                    mimeType: file.type,
                },
            });
        };
        reader.onerror = (error) => reject(error);
        reader.readAsDataURL(file);
    });
};

const App = () => {
    const [messages, setMessages] = useState([
        {
            id: 'initial-message',
            sender: 'bot',
            text: '안녕하세요! 파워넷 AI 어시스턴트입니다. 사내 규정, 근태, 법령 등 궁금한 점을 물어보세요.',
        },
    ]);
    const [isLoading, setIsLoading] = useState(false);
    const [knowledgeFiles, setKnowledgeFiles] = useState([]);
    const [isAdminPanelOpen, setIsAdminPanelOpen] = useState(false);

    const chatRef = useRef(null);
    const chatContainerRef = useRef(null);

    useEffect(() => {
        if (chatContainerRef.current) {
            chatContainerRef.current.scrollTop = chatContainerRef.current.scrollHeight;
        }
    }, [messages]);

    const getChat = useCallback(() => {
        if (!chatRef.current) {
            if (!process.env.API_KEY) {
                // In a real app, you would handle this more gracefully.
                // For this context, we assume the key is available.
                console.error("API_KEY is not set.");
                return;
            }
            const ai = new GoogleGenAI({ apiKey: process.env.API_KEY });
            chatRef.current = ai.chats.create({
                model: 'gemini-2.5-flash',
                config: {
                  systemInstruction: 'You are an AI assistant for PowerNet (파워넷). Your task is to answer employee questions based *only* on the information provided in the attached documents. Do not use any external knowledge. If the answer is not found in the documents, you must clearly state that the information is unavailable in the provided materials. Always respond in Korean.',
                }
            });
        }
        return chatRef.current;
    }, []);

    const handleSendMessage = useCallback(async (text) => {
        if (isLoading || !text.trim()) return;

        setIsLoading(true);
        const userMessage = { id: Date.now().toString(), sender: 'user', text };
        setMessages(prev => [...prev, userMessage]);

        const botMessageId = (Date.now() + 1).toString();
        const placeholderBotMessage = { id: botMessageId, sender: 'bot', text: '' };
        setMessages(prev => [...prev, placeholderBotMessage]);

        try {
            const chat = getChat();
            if (!chat) throw new Error("Chat not initialized. Check API Key.");
            
            const userParts = [{ text }];

            if (knowledgeFiles.length > 0) {
                userParts[0].text = `제공된 문서들의 내용을 기반으로 다음 질문에 답변해 주세요: "${text}"`;
                const fileParts = await Promise.all(
                    knowledgeFiles.map(file => fileToGenerativePart(file))
                );
                userParts.push(...fileParts);
            }
            
            const stream = await chat.sendMessageStream({ message: userParts });

            let fullResponse = '';
            for await (const chunk of stream) {
                fullResponse += chunk.text;
                setMessages(prev => prev.map(msg =>
                    msg.id === botMessageId ? { ...msg, text: fullResponse } : msg
                ));
            }

        } catch (error) {
            console.error('Error sending message:', error);
            const errorMessage = '죄송합니다, 답변을 생성하는 중에 오류가 발생했습니다. 잠시 후 다시 시도해 주세요.';
            setMessages(prev => prev.map(msg =>
                msg.id === botMessageId ? { ...msg, text: errorMessage } : msg
            ));
        } finally {
            setIsLoading(false);
        }
    }, [isLoading, getChat, knowledgeFiles]);
    
    const handleAddFile = (file) => {
        setKnowledgeFiles(prev => [...prev, file]);
    };

    const handleRemoveFile = (fileName) => {
        setKnowledgeFiles(prev => prev.filter(f => f.name !== fileName));
    };

    return React.createElement('div', { className: "bg-slate-100 min-h-screen flex items-center justify-center font-sans" },
        React.createElement('div', { className: "flex flex-col w-full max-w-2xl h-[90vh] max-h-[700px] bg-white rounded-2xl shadow-2xl overflow-hidden border border-slate-200" },
            React.createElement('header', { className: "flex items-center justify-between p-4 border-b border-slate-200 bg-slate-50" },
                React.createElement('div', { className: "flex items-center" },
                    React.createElement(PowerNetIcon, { className: "h-8 w-8 text-blue-600" }),
                    React.createElement('div', { className: "ml-3" },
                        React.createElement('h1', { className: "text-lg font-bold text-slate-800" }, "파워넷 AI 어시스턴트"),
                        React.createElement('p', { className: "text-xs text-green-500 flex items-center" },
                            React.createElement('span', { className: "relative flex h-2 w-2 mr-1.5" },
                                React.createElement('span', { className: "animate-ping absolute inline-flex h-full w-full rounded-full bg-green-400 opacity-75" }),
                                React.createElement('span', { className: "relative inline-flex rounded-full h-2 w-2 bg-green-500" })
                            ),
                            "Online"
                        )
                    )
                ),
                React.createElement('button', {
                        onClick: () => setIsAdminPanelOpen(true),
                        className: "p-2 rounded-full text-slate-500 hover:bg-slate-200 hover:text-slate-800 transition-colors",
                        'aria-label': "Manage knowledge base"
                    },
                    React.createElement(SettingsIcon, { className: "w-6 h-6" })
                )
            ),
            React.createElement('main', { ref: chatContainerRef, className: "flex-1 overflow-y-auto p-6 space-y-6" },
                messages.map((msg, index) =>
                    React.createElement(ChatMessage, { key: msg.id, message: msg, isLastMessage: index === messages.length - 1 && msg.sender === 'bot' && isLoading })
                )
            ),
            React.createElement('footer', { className: "p-4 border-t border-slate-200 bg-white" },
                React.createElement(ChatInput, { onSend: handleSendMessage, isLoading: isLoading })
            ),
            isAdminPanelOpen && React.createElement(AdminPanel, {
                files: knowledgeFiles,
                onAddFile: handleAddFile,
                onRemoveFile: handleRemoveFile,
                onClose: () => setIsAdminPanelOpen(false)
            })
        )
    );
};
// --- END OF APP COMPONENT ---


// --- RENDER THE APP ---
const rootElement = document.getElementById('root');
if (!rootElement) {
  throw new Error("Could not find root element to mount to");
}
const root = ReactDOM.createRoot(rootElement);
root.render(React.createElement(App));

    </script>
</body>
</html>
