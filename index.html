<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Powernet Q&A 챗봇</title>
  <style>
    *{box-sizing:border-box} body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Apple SD Gothic Neo,Noto Sans KR,sans-serif;background:#f6f8fb;color:#111}
    header{background:#0d47a1;color:#fff;padding:18px 16px;font-weight:700}
    .container{max-width:900px;margin:24px auto;padding:0 16px}
    .hero{background:#e3f2fd;border:1px solid #bbdefb;padding:16px 18px;border-radius:12px;margin-bottom:16px}
    .chat{display:flex;flex-direction:column;height:60vh;min-height:420px;background:#fff;border:1px solid #e5e7eb;border-radius:12px;overflow:hidden}
    .messages{flex:1;overflow:auto;padding:16px}
    .msg{margin-bottom:12px;max-width:85%}
    .me{margin-left:auto;text-align:right}
    .bubble{display:inline-block;padding:10px 12px;border-radius:12px;line-height:1.4}
    .me .bubble{background:#e8f0fe}
    .bot .bubble{background:#f1f5f9}
    .inputbar{border-top:1px solid #e5e7eb;display:flex;gap:8px;padding:10px;background:#fafafa;align-items:center}
    input[type="text"]{flex:1;padding:12px;border:1px solid #cfd8dc;border-radius:10px;font-size:15px}
    input[type="file"]{display:none;}
    .file-label{padding:12px 16px;border-radius:10px;background:#4caf50;color:#fff;font-weight:700;cursor:pointer}
    button{padding:12px 16px;border:none;border-radius:10px;background:#1976d2;color:#fff;font-weight:700;cursor:pointer}
    button:disabled{opacity:.6;cursor:not-allowed}
    .footer{margin-top:10px;color:#607d8b;font-size:12px}
    @media (max-width:480px){.chat{height:70vh}}
  </style>
</head>
<body>
  <header>Powernet Q&A 챗봇 (GitHub Pages)</header>
  <div class="container">
    <div class="hero">
      <b>안내</b> — 이 버전은 파일 업로드 기능을 지원합니다. 파일을 업로드하고 질문하면 해당 파일의 내용을 기반으로 답변합니다.
    </div>

    <div class="chat" id="chat">
      <div class="messages" id="messages"></div>
      <form class="inputbar" id="form">
        <label for="file-input" class="file-label">파일 선택</label>
        <input type="file" id="file-input" accept=".pdf,.doc,.docx,.txt">
        <input id="q" type="text" placeholder="파일과 관련된 질문을 입력하세요." autocomplete="off" />
        <button id="send" type="submit">전송</button>
      </form>
    </div>

    <div class="footer">
      © Powernet — 이 UI는 GitHub Pages로 호스팅됩니다. 다우오피스 Link+/대시보드 iframe으로 손쉽게 임베드 가능.
    </div>
  </div>

  <script>
    const form = document.getElementById('form');
    const q = document.getElementById('q');
    const msgs = document.getElementById('messages');
    const sendBtn = document.getElementById('send');
    const fileInput = document.getElementById('file-input');

    function addMessage(text, who='bot'){
      const wrap = document.createElement('div');
      wrap.className = 'msg ' + (who==='me'?'me':'bot');
      const b = document.createElement('div');
      b.className = 'bubble';
      b.textContent = text;
      wrap.appendChild(b);
      msgs.appendChild(wrap);
      msgs.scrollTop = msgs.scrollHeight;
    }

    addMessage('안녕하세요! 파일을 업로드하고 질문하시면 해당 문서의 내용을 기반으로 답변해 드립니다.');

    form.addEventListener('submit', async (e)=>{
      e.preventDefault();
      const text = q.value.trim();
      const file = fileInput.files[0];
      
      if(!text && !file) {
        addMessage('질문이나 파일을 업로드해주세요.', 'bot');
        return;
      }

      let displayMessage = text;
      if (file) {
        displayMessage = `📄 [${file.name}]와(과) 함께 질문: ${text}`;
      }
      addMessage(displayMessage,'me');
      q.value='';
      q.focus();

      // 로딩 상태 표시
      sendBtn.disabled = true;
      addMessage('답변 생성 중...', 'bot');

      // FormData 객체로 파일과 질문을 함께 전송
      const formData = new FormData();
      formData.append('query', text);
      if (file) {
        formData.append('file', file);
      }

      try {
        const res = await fetch('/chat', {
          method: 'POST',
          body: formData // Content-Type 헤더는 FormData 사용 시 자동으로 설정됨
        });

        if (!res.ok) {
          throw new Error(`HTTP error! status: ${res.status}`);
        }

        const data = await res.json();
        
        // "답변 생성 중..." 메시지 제거
        if (msgs.lastChild && msgs.lastChild.textContent.includes('답변 생성 중')) {
          msgs.lastChild.remove();
        }
        
        addMessage(data.answer || '죄송합니다. 답변을 찾을 수 없습니다.');
      } catch (error) {
        console.error('API Error:', error);
        if (msgs.lastChild && msgs.lastChild.textContent.includes('답변 생성 중')) {
          msgs.lastChild.remove();
        }
        addMessage('죄송합니다. 현재 챗봇 서버에 문제가 있습니다.');
      } finally {
        sendBtn.disabled = false;
      }
    });
  </script>
</body>
</html>
